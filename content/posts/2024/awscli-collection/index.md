---
title: "Awesome AWS CLI"
description : "Make your life easier with few awscli tips"
date: 2024-01-07
lastmod: 2024-01-07
draft: false
thumbnail: ./cover.jpg
usePageBundles: true
codeMaxLines: 50
codeLineNumbers: true
categories:
- blogging
isCJKLanguage: false
tags:
- AWS
- AWS CLI
- Amazon CodeWhisperer
- Tips
- Collections
---
> **Disclaimer**: the cover image was generated by Amazon Bedrock's Titan Image Generator G1.

[AWS CLI][awscli] is a swiss knife for orchestrating the operations of AWS resources. Especially, the filter option could help your filter and transform the output then combine with other Linux commands together.

This post collects the CLI usages to resolve my AWS operation needs.

### Delete the legacy versions of a service catalog product

AWS Service Catalog has [default 100 versions per product][service-catalog-limits]. Below is a one line command to delete the legacy versions.

{{< highlight bash >}}

export PRODUCT_ID=<product-id>

# query the version name starting with 'v5.0.0' then show Id and Name only
aws servicecatalog describe-product --no-paginate --id $PRODUCT_ID --query 'ProvisioningArtifacts[?starts_with(Name, `v5.0.0`)].{Id:Id, Name:Name}'

# query the version name contains 'v5.0.0-beta' then delete them
aws servicecatalog describe-product --no-paginate --id $PRODUCT_ID --query 'ProvisioningArtifacts[?contains(Name, `v5.0.0-beta`)].Id'  |jq -r '.[]' | xargs -I {} aws servicecatalog delete-provisioning-artifact --product-id $PRODUCT_ID --provisioning-artifact-id {}

{{< /highlight >}}

### Public all S3 objects with specific prefix

{{< highlight bash >}}

aws s3 ls s3://$name/$prefix --recursive | awk '{print $4}' | xargs -I {} -n 1 aws s3api put-object-acl --acl public-read --bucket $name --key {}

{{< /highlight >}}

### Reset resource policy of CloudWatch logs

You might encounter a CloudFormation stack deployment failure due to creating CloudWatch log group with an error message like the one below,

> Cannot enable logging. Policy document length breaking Cloudwatch Logs Constraints, either < 1 or > 5120 (Service: AmazonApiGatewayV2; Status Code: 400; Error Code: BadRequestException; Request ID: xxx-yyy-zzz; Proxy: null)

[CloudWatch Logs resource policies are limited to 5120 characters][cloudwatch-log-policy-limits]. The remediation is merging or removing useless policies, then updating the resource policies of CloudWatch logs to reduce the number of policies.

Below is a sample command to reset resource policy of CloudWatch logs:

{{< gist zxkane e33bf78c5e4908e0e8f0ec98f6914a07 "reset.sh" >}}

### Push Helm chart to all regional ECR repositories

{{< gist zxkane f548965c8d84871cd8f5eb4ceaaffbc9 "push-helm-chart-to-all-ecr-regions.sh" >}}

### Import a local SSH key to all AWS regions

{{< gist zxkane a12d75947e8e25951bca6d21669aad9d "import-ssh-keys-in-all-regions.sh" >}}

### Query latest amazon linux2 AMI

{{< gist zxkane b5ffbdeab2efacde4125c17a9f1de2c8 "query.sh" >}}

### Delete multiple CloudWatch Log groups

{{< gist zxkane a21502fcee9a05d17d61f31fca04eb6f "delete-loggroups.sh" >}}

### Launch an EC2 within default VPC with default security group

Add below script in your `.zshrc`, then run `ec2-launch-amazon-linux` in terminal to launch a new instance.

{{< gist zxkane e1d32abc182fc66c3079d14ccdea42ca ".zshrc" >}}

[Amazon CodeWhisperer for command line][codewhisperer-cli] is a new set of capabilities and integrations for AI-powered productivity tool, Amazon CodeWhisperer, that makes software developers more productive in the command line. It can also assist you generating the CLI command based on your natural language inputs.

[awscli]: https://aws.amazon.com/cli/
[cli-filter]: https://docs.aws.amazon.com/cli/v1/userguide/cli-usage-filter.html
[service-catalog-limits]: https://docs.aws.amazon.com/servicecatalog/latest/adminguide/limits.html
[cloudwatch-log-policy-limits]: https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/AWS-logs-and-resource-policy.html#AWS-logs-infrastructure-CWL
[codewhisperer-cli]: https://aws.amazon.com/blogs/devops/introducing-amazon-codewhisperer-for-command-line/
